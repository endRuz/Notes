# Golang 包和文件

- [Golang 包和文件](#golang-包和文件)
  - [包声明](#包声明)
  - [包的初始化](#包的初始化)
  - [导入声明](#导入声明)
    - [导入包的重命名](#导入包的重命名)
    - [匿名导入](#匿名导入)
  - [包文档](#包文档)
  - [内部包](#内部包)

Golang 的代码通过包（package）组织，包类似于其它语言里的库（libraries）或者模块（modules），目的都是为了支持模块化、封装、单独编译和代码重用。

Golang 有超过 `200` 个的标准包（可以用 `go list std | wc -l` 命令查看标准包的具体数目），标准库为大多数的程序提供了必要的基础构件。

## 包声明

一个包由位于单个目录下的一个或多个 `.go` 源代码文件组成，目录定义包的作用。

每个源文件都中第一段有效代码必须是包声明语句，包声明语句的主要目的是确定当前包被其它包导入时默认的标识符（也称为包名）。

通常来说，默认的包名就是包导入路径名的最后一段，但也有三种例外情况：

1. 包对应一个可执行程序，也就是 `main` 包，这时候 `main` 包本身的导入路径是无关紧要的。名字为 `main` 的包是给 `go build` 构建命令一个信息，这个包编译完之后必须调用连接器生成一个可执行程序。
2. 包所在的目录中可能有一些文件名是以 `_test.go` 为后缀的源文件（前面必须有其它的字符，因为以 `_` 或 `.` 开头的源文件会被构建工具忽略），并且这些源文件声明的包名也是以 `_test` 为后缀名的。这种目录可以包含两种包：一种是普通包，另一种则是测试的外部扩展包。所有以 `_test` 为后缀包名的测试外部扩展包都由 `go test` 命令独立编译，普通包和测试的外部扩展包是相互独立的。
3. 一些依赖版本号的管理工具会在导入路径后追加版本号信息，例如 `gopkg.in/yaml.v2`。这种情况下包的名字并不包含版本号后缀，而是 `yaml`。

> **注：** 例如包导入路径 `gopl.io/ch1/helloworld` 对应的目录路径是 `$GOPATH/src/gopl.io/ch1/helloworld`。

## 包的初始化

包的初始化首先是解决包级变量的依赖顺序，然后按照包级变量声明出现的顺序依次初始化：

```go
var a = b + c // a 第三个初始化, 为 3
var b = f()   // b 第二个初始化, 为 2, 通过调用 f (依赖c)
var c = 1     // c 第一个初始化, 为 1

func f() int { return c + 1 }
```

如果包中含有多个源文件，它们将按照发给编译器的顺序进行初始化，构建工具首先会将源文件根据文件名排序，然后依次调用编译器编译。

对于在包级别声明的变量，如果有初始化表达式则用表达式初始化，还有一些没有初始化表达式的，例如某些表格数据初始化并不是一个简单的赋值过程。在这种情况下，我们可以用一个特殊的 `init` 函数来简化初始化工作。每个文件都可以包含**多个** `init` 函数。

```go
func init() { /* ... */ }
```

这样的 `init` 函数除了不能被调用或引用外，其他行为和普通函数类似。在每个文件中的 `init` 函数，在程序开始执行时按照它们声明的顺序被自动调用。

## 导入声明

在一个 Golang 源文件包声明语句之后，其它非导入声明语句之前，包含零到多个导入包声明语句。

导入有两种基本格式，即单行导入和多行导入，两种导入方法的导入代码效果是一致的。

单行导入:

```go
import "fmt"
import "os"
```

多行导入：

```go
import (
    "fmt"
    "os"
)
```

导入的包之间可以通过添加空行来分组；通常将来自不同组织的包独自分组。包的导入顺序无关紧要，但是在每个分组中一般会根据字符串顺序排列。（`gofmt` 和 `goimports` 工具都可以将不同分组导入的包独立排序。）

```go
import (
    "fmt"
    "html/template"
    "os"

    "golang.org/x/net/html"
    "golang.org/x/net/ipv4"
)
```

### 导入包的重命名

因为默认包名一般采用导入路径名的最后一段，所以即使两个包的导入路径不同，它们依然可能有一个相同的包名。例如 `math/rand` 包和 `crypto/rand` 包，那么导入声明必须至少为一个同名包指定一个新的包名以避免冲突。这叫做导入包的重命名。

```go
import (
    "crypto/rand"
    mrand "math/rand" // alternative name mrand avoids conflict
)
```

导入包的重命名只影响当前的源文件。

### 匿名导入

如果只是导入一个包而并不使用导入的包将会导致一个编译错误。但是有时候我们只是想利用导入包而产生的副作用：它会计算包级变量的初始化表达式和执行导入包的 `init` 初始化函数。这时候我们需要抑制 `unused import` 编译错误，我们可以用下划线 `_` 来重命名导入的包。像往常一样，下划线 `_` 为空白标识符，并不能被访问。

```go
import _ "image/png" // register PNG decoder
```

这个被称为包的匿名导入。

## 包文档

Golang 包中每个导出的成员和包声明前都应该包含目的和用法说明的注释：

- 如果注释后紧跟着包声明语句，那注释对应整个包的文档。
- 如果注释后紧跟着导出的成员，那注释对应该导出的成员。

如果包的注释内容比较长，一般会放到一个独立的源文件中。这个专门用于保存包文档的源文件通常叫 `doc.go`。

## 内部包

Golang 的构建工具对包含 `internal` 名字的路径段的包导入路径做了特殊处理。这种包叫 `internal` 包，一个 `internal` 包只能被和 `internal` 目录有同一个父目录的包所导入。

例如，`net/http/internal/chunked` 内部包只能被 `net/http/httputil` 或 `net/http` 包导入，但是不能被 `net/url` 包导入。不过 `net/url` 包却可以导入 `net/http/httputil` 包。

```text
net/http
net/http/internal/chunked
net/http/httputil
net/url
```
